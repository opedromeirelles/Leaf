@model Leaf.Models.Compra

@{
    ViewData["Title"] = "Nova Compra";
}

@if (TempData["MensagemErro"] != null)
{
    <span id="eventoErro">@TempData["MensagemErro"]</span>
}
else if (TempData["MensagemSucesso"] != null)
{
    <span id="eventoSucesso">@TempData["MensagemSucesso"]</span>
}

<div class="paginaPadrao">
    <h2 class="h2tituloCadastro">Nova Ordem de Compra</h2>

    <form asp-action="Emitir" asp-controller="Compra" method="post" id="formCadastroCompra">
       
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    @await Html.PartialAsync("PartialView/BuscarInsumo")
                </div>

            </div>

            <div class="col-md-6">
                <div class="form-group">
                   @await Html.PartialAsync("PartialView/BuscarPessoa")
                </div>
            </div>
        </div>

        <input type="text" id="idUsuario" name="IdUsuario" hidden />
       

        <div class="btnsControles mt-4">
            <button type="submit" name="action" value="salvar" class="btn btn-success" id="btnSubmit" disabled>CONFIRMAR</button>
            <a href="@Url.Action("Index", "Compra")" class="btn btn-danger">DESCARTAR</a>
        </div>
    </form>
</div>

<!-- Referências ao Bootstrap e jQuery -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<!-- Rotinas em AJAX-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/js/validacao.js"></script>
<script>
    $(document).ready(function () {
        // Importando Função para validar pessoa
        iniciarValidacaoPessoa(
            'btnSubmit',          // ID do botão de confirmação
            'inpCnpj',            // ID do campo CNPJ
            'btnValidarCnpj',     // ID do botão de validação
            'spnValidacao',       // ID do label de validação
            'spnPessoaNome',      // ID do label de nome da pessoa
            'idPessoa'            // ID do campo oculto para armazenar o ID da pessoa
        );

        // Sobrescreva a URL para a validação específica de Pessoa para validação
        $.ajaxSetup({
            url: '/Pessoa/ValidarPessoa'
        });



        // Função para exibir insumos na tabela
        function exibirInsumos(insumos, listaElementoId, mensagemElementoId) {
            // Verifica se a lista está vazia
            if (insumos.length === 0) {
                $(`#${mensagemElementoId}`).html('<div class="alert alert-warning text-center">Nenhum insumo encontrado.</div>');
                return;
            }

            // Limpa a mensagem e a lista antes de popular
            $(`#${mensagemElementoId}`).html('');
            $(`#${listaElementoId}`).html('');

            // Popula a tabela com os insumos
            $.each(insumos, function (index, insumo) {
                $(`#${listaElementoId}`).append(`
                        <tr>
                            <td>${insumo.descricao}</td>
                            <td>R$ ${insumo.valorUnitario}</td>
                            <td><input type="number" class="w-50" id="idQuantidade_${index}" /></td>
                            <td>${insumo.pessoa?.nome ?? '-'}</td>
                            <td><a href="#" id="adicionarInsumo_${index}" class="btn btn-primary w-70">Adicionar</a></td>
                        </tr>
                    `);
            });
        }



        // Rotina de listar produtos já com a pessoa preenchida - case 1:
        $('#btnModalInsumo').click(function () {

            // Captar a pessoa se já estiver preenchida
            var idPessoa = 0;
            var nomePessoa = $('#spnPessoaNome').text();

            // Verifica se o campo CNPJ está vazio
            if ($('#inpCnpj').val().trim() === "") {
                idPessoa = 0;
                $('#pessoaVinculada').html('');
            } else {
                idPessoa = $('#idPessoa').val();
                $('#pessoaVinculada').html(`<br>${nomePessoa}`);
            }

            // Limpar todos os elementos antes de popular
            $('#listaInsumo').html('');
            $('#mensagemControle').html('');
            $('#inputBuscaInsumo').val('');

            // Acionar a action de listar insumos para a pessoa
            $.ajax({
                url: '/Compra/ListarInsumos',
                type: 'GET',
                data: { idPessoa: idPessoa },
                dataType: 'json',

                // Retornando a lista
                success: function (insumos) {
                    // Exibe os insumos usando a função
                    exibirInsumos(insumos, 'listaInsumo', 'mensagemControle');

                     },
                error: function () {
                    $('#listaInsumo').html('');
                    $('#mensagemControle').html('<div class="alert alert-warning">Erro ao consultar insumos.</div>');
                }
            });

            //Busca dentro do modal ja aberto
            $('#btnBuscaInsumo').click(function () {

                // Verifica se o campo CNPJ está vazio
                if ($('#inpCnpj').val().trim() === "") {
                    idPessoa = 0;
                } else {
                    idPessoa = $('#idPessoa').val();
                }

                // Pega a descrição
                var descricao = $('#inputBuscaInsumo').val();

                //chama rota para buscar
                $.ajax({
                    url: '/Compra/ListarInsumoPessoa',
                    type: 'GET',
                    data: { idPessoa: idPessoa, descricao: descricao },
                    dataType: 'json',

                    //Retorno
                    success: function (insumos) {
                        $('#listaInsumo').html('');
                        // Exibe os insumos usando a função
                        exibirInsumos(insumos, 'listaInsumo', 'mensagemControle');

                    },
                    error: function () {
                        $('#listaInsumo').html('');
                        $('#mensagemControle').html('<div class="alert alert-warning">Erro ao consultar insumos filtrado</div>');
                    }
                });
            });
        });

        //Limpar dentro do modal ja aberto
        $('#btnLimparBusca').click(function () {

            // Limpar busca
            $('#inputBuscaInsumo').val('');

            // Acionar a action de listar insumos para a pessoa
            $.ajax({
                url: '/Compra/ListarInsumos',
                type: 'GET',
                data: { idPessoa: idPessoa },
                dataType: 'json',

                // Retornando a lista
                success: function (insumos) {
                    // Exibe os insumos usando a função
                    exibirInsumos(insumos, 'listaInsumo', 'mensagemControle');

                },
                error: function () {
                    $('#listaInsumo').html('');
                    $('#mensagemControle').html('<div class="alert alert-warning">Erro ao consultar insumos.</div>');
                }
            });
        });
    });
</script>
